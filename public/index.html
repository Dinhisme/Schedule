<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω L·ªãch Tr·ª±c</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/x-icon" href="img/logoKHTHIT.ico">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>QU·∫¢N L√ù L·ªäCH TR·ª∞C</h1>
            <p>S·∫Øp x·∫øp l·ªãch tr·ª±c d·ªÖ d√†ng cho c√°c khoa ph√≤ng</p>

            <div style="float:right; margin-top: -50px;">
                <span id="userInfo"></span>
                <button id="logoutBtn" class="btn btn-secondary" style="display:none; margin-left: 5px;"
                    onclick="logout()">ƒêƒÉng
                    xu·∫•t</button>
            </div>

            <div style="float:left; margin-top: -40px;">
                <a href="/home" class="btn btn-home" style="border: 1px solid plum; text-decoration: none;">Trang l·ªãch
                    ƒë·∫ßy ƒë·ªß</a>
            </div>
        </div>

        <div class="department-manager">
            <!-- <h3>Qu·∫£n l√Ω Khoa/Ph√≤ng</h3> -->
            <!-- <div class="department-input">
                <input type="text" id="departmentInput" placeholder="Nh·∫≠p t√™n khoa/ph√≤ng..."
                    onkeypress="handleDepartmentEnter(event)">
                <button class="btn btn-primary" onclick="addDepartment()">Th√™m Khoa/Ph√≤ng</button>
            </div> -->
            <div class="department-list" id="departmentList"></div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary active" id="currentWeekBtn" onclick="showWeek('current')">Tu·∫ßn Hi·ªán
                T·∫°i</button>
            <button class="btn btn-secondary" id="nextWeekBtn" onclick="showWeek('next')">Tu·∫ßn Ti·∫øp Theo</button>
            <button class="btn btn-secondary" onclick="exportSchedule()">üìã Xu·∫•t L·ªãch</button>
            <!-- <button class="btn btn-primary" onclick="clearAllSchedules()">üóëÔ∏è X√≥a T·∫•t C·∫£</button> -->
            <button class="btn btn-primary" onclick="rotateTuaTrucLanhDao()">üîÑ Xoay tua tu·∫ßn t·ªõi</button>
        </div>

        <div id="currentWeekSchedule" class="schedule-container">
            <div class="week-title" id="currentWeekTitle"></div>
            <div class="schedule-grid" id="currentGrid"></div>
        </div>

        <div id="nextWeekSchedule" class="schedule-container" style="display: none;">
            <div class="week-title" id="nextWeekTitle"></div>
            <div class="schedule-grid" id="nextGrid"></div>
        </div>
    </div>

    <!-- Modal for editing shifts -->
    <div id="shiftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ch·ªânh S·ª≠a Ca Tr·ª±c</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="staffName">T√™n Nh√¢n Vi√™n:</label>
                <input type="text" id="staffName" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n...">
            </div>
            <div class="form-group">
                <label for="notes">Ghi Ch√∫:</label>
                <input type="text" id="notes" placeholder="Ghi ch√∫ th√™m...">
            </div>
            <div class="modal-actions">
                <button id="deleteShift" class="btn btn-danger" onclick="deleteShift()">X√≥a Ca</button>
                <button class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
                <button id="saveShift" class="btn btn-primary" onclick="saveShift()">L∆∞u</button>
            </div>
        </div>
    </div>



    <script>
        let departments = ['Tr·ª±c L√£nh ƒê·∫°o', 'Th∆∞·ªùng tr√∫', 'Tr∆∞·ªüng tua', 'Bs Khoa CC', 'Khoa C·∫•p C·ª©u', 'Khoa CC Nhi-S∆° sinh', 'Bs Khoa Sanh', 'Khoa Sanh', 'Bs Khoa SB', 'Khoa SB', 'Bs Khoa Ph·ª•', 'Khoa Ph·ª•', 'Bs Khoa HP', 'Khoa HP',
            'Bs Khoa HS', 'Khoa HS', 'Bs Khoa ƒêTTYC', 'Khoa ƒêTTYC', 'Khu A', 'Khu B', 'Khu C', 'TT Khoa Ptgm Hsct-Cƒë', 'Khoa Ptgm Hsct-Cƒë Kv G√¢y m√™', 'Khoa Ptgm-Hstc-Cƒë KV ICU',
            'Khoa Ptgm-Hstc-Cƒë Bs Kh·∫©m Ti·ªÅn M√™', 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë Ng√†y', 'ƒêD tr∆∞c ICU Ng√†y', 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë ƒê√™m', 'ƒêD tr·ª±c ICU ƒê√™m',
            'TT Khoa Nhi-Ss', 'Khoa Nhi-S∆° Sinh', 'Khoa Ksnk Th∆∞·ªùng Tr√∫', 'X√©t Nghi·ªám', 'Si√™u √Çm', 'TT S√¢ Tim', 'X Quang', 'TT X Quang', 'K·∫ø To√°n',
            'KD∆∞·ª£c', 'Th∆∞·ªùng Tr√∫ B·∫£o Tr√¨', 'Phcqt', 'T√†i X·∫ø', 'Tin H·ªçc', 'Khoa Nhi SS TK', 'Khoa Ptgm-Hstc-Cd (KV h·ªìi s√∫c sau m·ªó) TK', 'ƒêD Tr·ª±c Ptgm Hstc-Cd Ng√†y TK',
            'ƒêD Tr·ª±c Ptgm Hstc-Cd ƒê√™m TK', 'Khoa Ph·ª• TK', 'Khoa Sanh TK', 'Khoa SB TK', 'Khoa C–° TK', 'Khoa Sanh 13h-17h', 'Khoa CC 13h-17h', 'Khoa Ptgm-Hstc-Cƒë',
            'Khoa Sanh TC'
        ];
        let currentWeekSchedule = {};
        let nextWeekSchedule = {};
        let currentEditingCell = null;
        let activeWeek = 'current';
        let currentUser = JSON.parse(localStorage.getItem('currentUser')); // {username, departments: []}



        // Initialize the application
        function init() {
            if (!currentUser) {
                window.location.href = '/login.html'; // Redirect to login page if not logged in
                return;
            }
            loadScheduleFromServer();
            loadUserDepartments();
            renderDepartments();
            generateScheduleGrids();
            updateWeekTitles();
        }

        function rotateTuaTrucLanhDao() {
            // L·∫∑p qua t·∫•t c·∫£ c√°c khoa/ph√≤ng m√† user c√≥ quy·ªÅn
            departments.forEach((dept) => {
                // X√°c ƒë·ªãnh c√°c shift cho dept n√†y (gi·ªëng nh∆∞ trong generateGrid)
                let shifts;
                switch (dept) {
                    case 'Tr·ª±c L√£nh ƒê·∫°o':
                    case 'Th∆∞·ªùng tr√∫':
                    case 'Tr∆∞·ªüng tua':
                    case 'Khu A':
                    case 'Khu B':
                    case 'Khu C':
                    case 'TT Khoa Ptgm Hsct-Cƒë':
                    case 'Khoa Ptgm-Hstc-Cƒë KV ICU':
                    case 'Khoa Ptgm-Hstc-Cƒë Bs Kh·∫©m Ti·ªÅn M√™':
                    case 'ƒêD tr∆∞c ICU Ng√†y':
                    case 'ƒêD tr·ª±c ICU ƒê√™m':
                    case 'TT Khoa Nhi-Ss':
                    case 'Khoa Ptgm-Hstc-Cd (KV h·ªìi s√∫c sau m·ªó) TK':
                    case 'ƒêD Tr·ª±c Ptgm Hstc-Cd Ng√†y TK':
                    case 'ƒêD Tr·ª±c Ptgm Hstc-Cd ƒê√™m TK':
                    case 'Khoa Ph·ª• TK':
                    case 'Khoa Sanh TK':
                    case 'Khoa SB TK':
                    case 'Khoa C–° TK':
                    case 'Khoa Sanh 13h-17h':
                    case 'Khoa CC 13h-17h':
                    case 'Khoa Ptgm-Hstc-Cƒë':
                    case 'Khoa Sanh TC':
                        shifts = ['H√†ng 1'];
                        break;
                    case 'Bs Khoa CC':
                    case 'Bs Khoa Sanh':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'];
                        break;
                    case 'Khoa C·∫•p C·ª©u':
                    case 'Khoa Sanh':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', 'H√†ng 9', 'H√†ng 10', 'H√†ng 11', 'H√†ng 12'];
                        break;
                    case 'Khoa CC Nhi-S∆° sinh':
                        shifts = ['H√†ng 1', 'H√†ng 2'];
                        break;
                    case 'Khoa SB':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6'];
                        break;
                    case 'Khoa Ph·ª•':
                    case 'Khoa HP':
                    case 'Khoa HS':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'];
                        break;
                    case 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë Ng√†y':
                    case 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë ƒê√™m':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8'];
                        break;
                    case 'Khoa Nhi-S∆° Sinh':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', 'H√†ng 9', 'H√†ng 10'];
                        break;
                    case 'Khoa Ksnk Th∆∞·ªùng Tr√∫':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];
                        break;
                    case 'X√©t Nghi·ªám':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'];
                        break;
                    case 'Si√™u √Çm':
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];
                        break;
                    default:
                        shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];
                        break;
                }

                const deptIndex = departments.indexOf(dept);

                shifts.forEach((shift) => {
                    // L·∫•y danh s√°ch 7 ng∆∞·ªùi tr·ª±c tu·∫ßn n√†y cho dept v√† shift n√†y
                    let weekStaff = [];
                    for (let day = 0; day < 7; day++) {
                        const key = `${deptIndex}_${day}_${shift}`;
                        if (currentWeekSchedule[key] && currentWeekSchedule[key].staff) {
                            weekStaff.push(currentWeekSchedule[key].staff);
                        } else {
                            weekStaff.push(null);
                        }
                    }

                    // ƒê·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa t·ª´ng ng∆∞·ªùi
                    const staffCount = {};
                    weekStaff.forEach(name => {
                        if (name) staffCount[name] = (staffCount[name] || 0) + 1;
                    });

                    // T√¨m c√°c ng∆∞·ªùi b·ªã tr√πng l·∫∑p (xu·∫•t hi·ªán >1 l·∫ßn)
                    const duplicatedStaff = Object.keys(staffCount).filter(name => staffCount[name] > 1);

                    // X√°c ƒë·ªãnh s·ªë ng∆∞·ªùi tr√πng l·∫∑p li√™n ti·∫øp ·ªü cu·ªëi tu·∫ßn
                    let numDuplicatedAtEnd = 0;
                    for (let i = 6; i >= 0; i--) {
                        if (weekStaff[i] && duplicatedStaff.includes(weekStaff[i])) {
                            numDuplicatedAtEnd++;
                        } else {
                            break;
                        }
                    }

                    let nextWeekStaff = [];

                    if (duplicatedStaff.length === 0 || numDuplicatedAtEnd === 0) {
                        // Kh√¥ng ph√°t hi·ªán tua b·ªã tr√πng: Xoay tua ki·ªÉu ƒë√¥n l√™n
                        nextWeekStaff = [
                            weekStaff[1], weekStaff[2], weekStaff[3],
                            weekStaff[4], weekStaff[5], weekStaff[6], weekStaff[0]
                        ];
                    } else {
                        // C√≥ tua b·ªã tr√πng: Xoay nh∆∞ quy t·∫Øc c≈©
                        const tuaThucTe = 7 - numDuplicatedAtEnd;
                        const realStaff = weekStaff.slice(-tuaThucTe);
                        const duplicatedList = weekStaff.slice(numDuplicatedAtEnd - 7);
                        nextWeekStaff = [...duplicatedList, ...realStaff, ...duplicatedList].slice(0, 7);
                    }

                    // G√°n l·∫°i l·ªãch tu·∫ßn sau ƒë√∫ng th·ª© t·ª±
                    for (let day = 0; day < 7; day++) {
                        const key = `${deptIndex}_${day}_${shift}`;
                        nextWeekSchedule[key] = {
                            department: dept,
                            day: day,
                            shift: shift,
                            staff: nextWeekStaff[day] || "",
                            notes: ""
                        };
                    }
                });
            });

            saveScheduleToServer();
            showWeek('next');
            alert('ƒê√£ xoay tua tu·∫ßn t·ªõi cho t·∫•t c·∫£ c√°c khoa/ph√≤ng v√† ca tr·ª±c!');
        }

        // Department management
        function addDepartment() {
            const input = document.getElementById('departmentInput');
            const departmentName = input.value.trim();
            if (departmentName && !departments.includes(departmentName)) {
                departments.push(departmentName);
                input.value = '';
                renderDepartments();
                generateScheduleGrids();
                // L∆∞u l·∫°i v√†o t√†i kho·∫£n
                if (currentUser) {
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    users[currentUser.username].departments = departments;
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem('currentUser', JSON.stringify({ ...currentUser, departments }));
                }
            }
        }

        function handleDepartmentEnter(event) {
            if (event.key === 'Enter') {
                addDepartment();
            }
        }

        function removeDepartment(index) {
            departments.splice(index, 1);
            renderDepartments();
            generateScheduleGrids();
            // L∆∞u l·∫°i v√†o t√†i kho·∫£n
            if (currentUser) {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                users[currentUser.username].departments = departments;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify({ ...currentUser, departments }));
            }
        }

        function renderDepartments() {
            const container = document.getElementById('departmentList');
            container.innerHTML = departments.map((dept, index) =>
                `<div class="department-tag">
                    ${dept}
                    <button class="remove" onclick="removeDepartment(${index})">√ó</button>
                </div>`
            ).join('');
        }

        // Week management
        function showWeek(week) {
            activeWeek = week;
            document.getElementById('currentWeekBtn').classList.toggle('active', week === 'current');
            document.getElementById('nextWeekBtn').classList.toggle('active', week === 'next');
            document.getElementById('currentWeekSchedule').style.display = week === 'current' ? 'block' : 'none';
            document.getElementById('nextWeekSchedule').style.display = week === 'next' ? 'block' : 'none';
        }

        function updateWeekTitles() {
            const today = new Date();
            const currentMonday = getMonday(today);
            const nextMonday = new Date(currentMonday);
            nextMonday.setDate(nextMonday.getDate() + 7);

            document.getElementById('currentWeekTitle').textContent =
                `Tu·∫ßn Hi·ªán T·∫°i (${formatDate(currentMonday)} - ${formatDate(new Date(currentMonday.getTime() + 6 * 24 * 60 * 60 * 1000))})`;
            document.getElementById('nextWeekTitle').textContent =
                `Tu·∫ßn Ti·∫øp Theo (${formatDate(nextMonday)} - ${formatDate(new Date(nextMonday.getTime() + 6 * 24 * 60 * 60 * 1000))})`;
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        }

        // Schedule grid generation
        function generateScheduleGrids() {
            generateGrid('currentGrid');
            generateGrid('nextGrid');
        }

        // Thay ƒë·ªïi trong h√†m generateGrid ƒë·ªÉ th√™m thu·ªôc t√≠nh draggable v√† c√°c s·ª± ki·ªán drag & drop
        function generateGrid(gridId) {
            const grid = document.getElementById(gridId);
            const daysOfWeek = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß Nh·∫≠t'];
            grid.innerHTML = '';
            grid.appendChild(createGridCell('Khoa/Ph√≤ng', 'grid-header'));
            daysOfWeek.forEach(day => {
                grid.appendChild(createGridCell(day, 'grid-header'));
            });

            departments.forEach((dept, deptIndex) => {
                grid.appendChild(createGridCell(dept, 'grid-cell department-row'));
                for (let day = 0; day < 7; day++) {
                    const cell = createGridCell('', 'grid-cell');
                    const cellId = `${gridId}_${deptIndex}_${day}`;
                    cell.id = cellId;
                    // const shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3']; // C√°c ca tr·ª±c
                    // Add shift slots
                    let shifts;
                    switch (dept) {
                        case 'Tr·ª±c L√£nh ƒê·∫°o':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Th∆∞·ªùng tr√∫':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Tr∆∞·ªüng tua':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Bs Khoa CC':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'];
                            break;
                        case 'Khoa C·∫•p C·ª©u':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', 'H√†ng 9', 'H√†ng 10', 'H√†ng 11', 'H√†ng 12'];
                            break;
                        case 'Khoa CC Nhi-S∆° sinh':
                            shifts = ['H√†ng 1', 'H√†ng 2']
                            break;
                        case 'Bs Khoa Sanh':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'];
                            break;
                        case 'Khoa Sanh':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', 'H√†ng 9', 'H√†ng 10', 'H√†ng 11', 'H√†ng 12'];
                            break;
                        case 'Bs Khoa SB':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa SB':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6'];
                            break;
                        case 'Bs Khoa Ph·ª•':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Ph·ª•':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'];
                            break;
                        case 'Bs Khoa HP':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa HP':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'];
                            break;
                        case 'Bs Khoa HS':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa HS':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'];
                            break;
                        case 'Bs Khoa ƒêTTYC':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa ƒêTTYC':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khu A':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khu B':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khu C':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'TT Khoa Ptgm Hsct-Cƒë':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Ptgm-Hstc-Cƒë KV G√¢y m√™':
                            shifts = ['H√†ng 1', 'H√†ng 2'];
                            break;
                        case 'Khoa Ptgm-Hstc-Cƒë KV ICU':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Pigm-Hstc-Cƒë Bs Kh·∫©m Ti·ªÅn M√™':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë Ng√†y':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8'];
                            break;
                        case 'ƒêD tr∆∞c ICU Ng√†y':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë ƒê√™m':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8'];
                            break;
                        case 'ƒêD tr·ª±c ICU ƒê√™m':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'TT Khoa Nhi-Ss':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Nhi-S∆° Sinh':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', ' H√†ng 9', 'H√†ng 10'];
                            break;
                        case 'Khoa Ksnk Th∆∞·ªùng Tr√∫':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];
                            break;
                        case 'X√©t Nghi·ªám':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'];
                            break;
                        case 'Si√™u √Çm':
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];
                            break;
                        case 'TT S√¢ Tim':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'X Quang':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'TT X Quang':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'K·∫ø To√°n':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa D∆∞·ª£c':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Th∆∞·ªùng Tr√∫ B·∫£o Tr√¨':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Phcqt':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'T√†i X·∫ø':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Tin H·ªçc':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Nhi SS TK':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Ptgm-Hstc-Cd (KV h·ªìi s√∫c sau m·ªó) TK':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'ƒêD Tr·ª±c Ptgm Hstc-Cd Ng√†y TK':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'ƒêD Tr·ª±c Ptgm Hstc-Cd ƒê√™m TK':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Ph·ª• TK':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Sanh TK':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa SB TK':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa C–° TK':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Sanh 13h-17h':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa CC 13h-17h':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Ptgm-Hstc-Cƒë':
                            shifts = ['H√†ng 1'];
                            break;
                        case 'Khoa Sanh TC':
                            shifts = ['H√†ng 1']
                            break;
                        default:
                            shifts = ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];
                            break;
                    }

                    shifts.forEach((shift, shiftIndex) => {
                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'shift-slot';
                        slotDiv.textContent = shift;
                        slotDiv.draggable = true;
                        slotDiv.dataset.deptIndex = deptIndex;
                        slotDiv.dataset.day = day;
                        slotDiv.dataset.shift = shift;
                        slotDiv.dataset.gridId = gridId;


                        activeWeek = gridId.includes('current') ? 'current' : 'next';
                        // Drag events
                        if (activeWeek == 'next') {
                            slotDiv.draggable = true;
                            slotDiv.ondragstart = handleDragStart;
                            slotDiv.ondragover = handleDragOver;
                            slotDiv.ondrop = handleDrop;
                            slotDiv.ondragenter = handleDragEnter;
                            slotDiv.ondragleave = handleDragLeave;
                        } else {
                            slotDiv.draggable = false;
                        }

                        // Click ƒë·ªÉ ch·ªânh s·ª≠a nh∆∞ c≈©
                        slotDiv.onclick = (e) => {
                            // N·∫øu ƒëang k√©o th√¨ kh√¥ng m·ªü modal
                            if (e.detail === 1 && !slotDiv.classList.contains('dragging')) {
                                openShiftModal(gridId, deptIndex, day, shift);
                            }
                        };

                        // Hi·ªÉn th·ªã d·ªØ li·ªáu n·∫øu c√≥
                        const week = gridId.includes('current') ? 'current' : 'next';
                        const scheduleData = week === 'current' ? currentWeekSchedule : nextWeekSchedule;
                        const key = `${deptIndex}_${day}_${shift}`;
                        const data = scheduleData[key];
                        if (data) {
                            slotDiv.className = 'shift-slot filled';
                            slotDiv.innerHTML = `<strong>${data.staff}</strong>`;
                        }

                        cell.appendChild(slotDiv);
                    });
                    grid.appendChild(cell);
                }
            });
        }

        function createGridCell(content, className) {
            const cell = document.createElement('div');
            cell.className = className;
            cell.innerHTML = content;
            return cell;
        }

        // Drag & Drop handlers
        let dragSource = null;
        function handleDragStart(e) {
            dragSource = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                deptIndex: this.dataset.deptIndex,
                day: this.dataset.day,
                shift: this.dataset.shift,
                gridId: this.dataset.gridId
            }));

        }
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

        }
        function handleDragEnter(e) {
            this.classList.add('drag-over');

        }
        function handleDragLeave(e) {
            this.classList.remove('drag-over');

        }
        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (!dragSource) return;
            const src = JSON.parse(e.dataTransfer.getData('text/plain'));
            const dest = {
                deptIndex: this.dataset.deptIndex,
                day: this.dataset.day,
                shift: this.dataset.shift,
                gridId: this.dataset.gridId
            };
            // Kh√¥ng cho k√©o v√†o ch√≠nh n√≥
            if (src.deptIndex === dest.deptIndex && src.day === dest.day && src.shift === dest.shift && src.gridId === dest.gridId) return;

            // L·∫•y d·ªØ li·ªáu ngu·ªìn
            const srcWeek = src.gridId.includes('current') ? 'current' : 'next';
            const srcSchedule = srcWeek === 'current' ? currentWeekSchedule : nextWeekSchedule;
            const srcKey = `${src.deptIndex}_${src.day}_${src.shift}`;
            const srcData = srcSchedule[srcKey];

            // L·∫•y d·ªØ li·ªáu ƒë√≠ch
            const destWeek = dest.gridId.includes('current') ? 'current' : 'next';
            const destSchedule = destWeek === 'current' ? currentWeekSchedule : nextWeekSchedule;
            const destKey = `${dest.deptIndex}_${dest.day}_${dest.shift}`;
            const destData = destSchedule[destKey];

            // N·∫øu c√≥ d·ªØ li·ªáu ngu·ªìn
            if (srcData) {
                // N·∫øu √¥ ƒë√≠ch ƒë√£ c√≥ ng∆∞·ªùi tr·ª±c, th·ª±c hi·ªán ho√°n ƒë·ªïi
                if (destData) {
                    // ƒê·ªïi ch·ªó hai ng∆∞·ªùi tr·ª±c
                    srcSchedule[srcKey] = { ...destData, department: departments[src.deptIndex], day: src.day, shift: src.shift };
                } else {
                    // N·∫øu √¥ ƒë√≠ch ch∆∞a c√≥ ai, x√≥a √¥ ngu·ªìn
                    delete srcSchedule[srcKey];
                }
                // ƒê·∫∑t ng∆∞·ªùi tr·ª±c m·ªõi v√†o √¥ ƒë√≠ch
                destSchedule[destKey] = { ...srcData, department: departments[dest.deptIndex], day: dest.day, shift: dest.shift };

                saveScheduleToServer();
                generateScheduleGrids();
            }
            dragSource.classList.remove('dragging');
            dragSource = null;
        }

        function openShiftModal(gridId, deptIndex, day, shift) {
            const week = gridId.includes('current') ? 'current' : 'next';

            // Disable/enable n√∫t theo tu·∫ßn
            document.getElementById('deleteShift').disabled = (week === 'current');
            document.getElementById('saveShift').disabled = (week === 'current');

            const scheduleData = week === 'current' ? currentWeekSchedule : nextWeekSchedule;
            const key = `${deptIndex}_${day}_${shift}`;

            currentEditingCell = { gridId, deptIndex, day, shift, week, key };

            const existingData = scheduleData[key];
            if (existingData) {
                document.getElementById('staffName').value = existingData.staff || '';
                document.getElementById('notes').value = existingData.notes || '';
            } else {
                document.getElementById('staffName').value = '';
                document.getElementById('notes').value = '';
            }

            document.getElementById('shiftModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('shiftModal').style.display = 'none';
            currentEditingCell = null;
        }

        function saveShiftMove() {

            const staffName = document.getElementById('staffName').value.trim();
            const notes = document.getElementById('notes').value.trim();

            const { week, key, gridId, deptIndex, day, shift } = currentEditingCell;
            const scheduleData = week === 'current' ? currentWeekSchedule : nextWeekSchedule;

            scheduleData[key] = {
                staff: staffName,
                notes: notes,
                department: departments[deptIndex],
                day: day,
                shift: shift
            };

            updateShiftDisplay(gridId, deptIndex, day, shift, scheduleData[key]);
            saveScheduleToServer();
        }

        function saveShift() {
            if (!currentEditingCell) return;
            if (activeWeek === 'current') return; // Kh√¥ng cho l∆∞u tu·∫ßn hi·ªán t·∫°i
            const staffName = document.getElementById('staffName').value.trim();
            const notes = document.getElementById('notes').value.trim();

            if (!staffName) {
                alert('Vui l√≤ng nh·∫≠p t√™n nh√¢n vi√™n!');
                return;
            }

            const { week, key, gridId, deptIndex, day, shift } = currentEditingCell;
            const scheduleData = week === 'current' ? currentWeekSchedule : nextWeekSchedule;

            scheduleData[key] = {
                staff: staffName,
                notes: notes,
                department: departments[deptIndex],
                day: day,
                shift: shift
            };

            updateShiftDisplay(gridId, deptIndex, day, shift, scheduleData[key]);
            closeModal();
            saveScheduleToServer();
        }

        function deleteShift() {
            if (!currentEditingCell) return;
            if (activeWeek === 'current') return; // Kh√¥ng cho x√≥a tu·∫ßn hi·ªán t·∫°i
            const { week, key, gridId, deptIndex, day, shift } = currentEditingCell;
            const scheduleData = week === 'current' ? currentWeekSchedule : nextWeekSchedule;

            delete scheduleData[key];
            updateShiftDisplay(gridId, deptIndex, day, shift, null);
            closeModal();
            saveScheduleToServer();
        }

        function updateShiftDisplay(gridId, deptIndex, day, shift, data) {
            const cellId = `${gridId}_${deptIndex}_${day}`;
            const cell = document.getElementById(cellId);
            const shiftSlots = cell.querySelectorAll('.shift-slot');

            // T√¨m ƒë√∫ng shiftIndex theo t√™n shift
            let shiftIndex = -1;
            shiftSlots.forEach((slot, idx) => {
                if (slot.dataset.shift === shift) shiftIndex = idx;
            });

            if (shiftIndex === -1) return; // Kh√¥ng t√¨m th·∫•y shift ph√π h·ª£p

            const slotDiv = shiftSlots[shiftIndex];

            if (data) {
                slotDiv.className = 'shift-slot filled';
                slotDiv.innerHTML = `<strong>${data.staff}</strong><br><small>${data.shift}</small>`;
            } else {
                slotDiv.className = 'shift-slot';
                slotDiv.textContent = shift;
            }
        }

        // Utility functions
        function exportSchedule() {
            const week = activeWeek === 'current' ? 'Hi·ªán T·∫°i' : 'Ti·∫øp Theo';
            const scheduleData = activeWeek === 'current' ? currentWeekSchedule : nextWeekSchedule;

            let exportText = `L·ªäCH TR·ª∞C TU·∫¶N ${week.toUpperCase()}\n`;
            exportText += '='.repeat(50) + '\n\n';

            departments.forEach((dept, deptIndex) => {
                exportText += `${dept.toUpperCase()}\n`;
                exportText += '-'.repeat(30) + '\n';

                for (let day = 0; day < 7; day++) {
                    const dayNames = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß Nh·∫≠t'];
                    exportText += `${dayNames[day]}:\n`;

                    ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'].forEach(shift => {
                        const key = `${deptIndex}_${day}_${shift}`;
                        const data = scheduleData[key];
                        if (data) {
                            exportText += `  ${shift}: ${data.staff}`;
                            if (data.notes) exportText += ` (${data.notes})`;
                            exportText += '\n';
                        } else {
                            exportText += `  ${shift}: Ch∆∞a x·∫øp\n`;
                        }
                    });
                    exportText += '\n';
                }
                exportText += '\n';
            });

            const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lich-truc-tuan-${week.toLowerCase()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAllSchedules() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ l·ªãch tr·ª±c?')) {
                currentWeekSchedule = {};
                nextWeekSchedule = {};
                generateScheduleGrids();
                saveScheduleToServer();
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('shiftModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // function showLogin() {
        //     document.getElementById('loginContainer').style.display = 'flex';
        //     document.getElementById('registerContainer').style.display = 'none';
        // }
        // function showRegister() {
        //     document.getElementById('loginContainer').style.display = 'none';
        //     document.getElementById('registerContainer').style.display = 'flex';
        // }



        // async function register() {
        //     const username = document.getElementById('registerUsername').value.trim();
        //     const password = document.getElementById('registerPassword').value;
        //     const departments = document.getElementById('registerDepartments').value.split(',').map(s => s.trim()).filter(Boolean);
        //     if (!username || !password || departments.length === 0) {
        //         document.getElementById('registerError').textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!';
        //         return;
        //     }
        //     const res = await fetch('/api/register', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json' },
        //         body: JSON.stringify({ username, password, departments })
        //     });
        //     if (res.ok) {
        //         document.getElementById('registerError').textContent = 'ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.';
        //         setTimeout(showLogin, 1000);
        //     } else {
        //         const data = await res.json();
        //         document.getElementById('registerError').textContent = data.error || 'L·ªói ƒëƒÉng k√Ω!';
        //     }
        // }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html'; // Redirect to login page
        }

        function loadUserDepartments() {
            if (!currentUser) return;
            // Ch·ªâ hi·ªÉn th·ªã khoa/ph√≤ng c·ªßa user
            departments = currentUser.departments.slice();
            renderDepartments();
            generateScheduleGrids();
            updateWeekTitles();
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('userInfo').textContent = 'üë§ ' + currentUser.username;
            console.log('Current user departments:', currentUser.username);
        }

        // L∆∞u l·ªãch tr·ª±c l√™n server
        async function saveScheduleToServer() {
            if (!currentUser) return;
            const weekKey = activeWeek === 'current' ? getCurrentWeekKey() : getNextWeekKey();
            const schedule = Object.values(activeWeek === 'current' ? currentWeekSchedule : nextWeekSchedule);
            await fetch('/api/save-schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: currentUser.username,
                    weekKey,
                    schedule
                })
            });
        }

        // T·∫£i l·ªãch tr·ª±c t·ª´ server
        async function loadScheduleFromServer() {
            if (!currentUser) return;
            // T·∫£i tu·∫ßn hi·ªán t·∫°i
            let weekKey = getCurrentWeekKey();
            let res = await fetch('/api/load-schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser.username, weekKey })
            });
            let data = await res.json();
            currentWeekSchedule = {};
            (data.schedule || []).forEach(item => {
                const key = `${departments.indexOf(item.department)}_${item.day}_${item.shift}`;
                currentWeekSchedule[key] = item;
            });

            // T·∫£i tu·∫ßn ti·∫øp theo
            weekKey = getNextWeekKey();
            res = await fetch('/api/load-schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser.username, weekKey })
            });
            data = await res.json();
            nextWeekSchedule = {};
            (data.schedule || []).forEach(item => {
                const key = `${departments.indexOf(item.department)}_${item.day}_${item.shift}`;
                nextWeekSchedule[key] = item;
            });

            generateScheduleGrids();
        }

        function loadAllSchedules() {
            fetch('/api/all-schedules')
                .then(res => res.json())
                .then(allSchedules => {
                    currentWeekSchedule = {};
                    nextWeekSchedule = {};
                    const weekKeyCurrent = getCurrentWeekKey();
                    const weekKeyNext = getNextWeekKey();

                    Object.values(allSchedules).forEach(userSchedule => {
                        // Tu·∫ßn hi·ªán t·∫°i
                        if (userSchedule.weeks && userSchedule.weeks[weekKeyCurrent]) {
                            userSchedule.weeks[weekKeyCurrent].forEach(item => {
                                if (departments.includes(item.department)) {
                                    const deptIndex = departments.indexOf(item.department);
                                    const key = `${deptIndex}_${item.day}_${item.shift}`;
                                    currentWeekSchedule[key] = item;
                                }
                            });
                        }
                        // Tu·∫ßn ti·∫øp theo
                        if (userSchedule.weeks && userSchedule.weeks[weekKeyNext]) {
                            userSchedule.weeks[weekKeyNext].forEach(item => {
                                if (departments.includes(item.department)) {
                                    const deptIndex = departments.indexOf(item.department);
                                    const key = `${deptIndex}_${item.day}_${item.shift}`;
                                    nextWeekSchedule[key] = item;
                                }
                            });
                        }
                    });
                    generateScheduleGrids();
                })
                .catch(() => {
                    alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu l·ªãch tr·ª±c!');
                });
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', init);

        function getCurrentWeekKey(date = new Date()) {
            const year = date.getFullYear();
            const week = getISOWeekNumber(date);
            return `${year}-${week}`;
        }
        function getNextWeekKey() {
            const today = new Date();
            const nextMonday = getMonday(today);
            nextMonday.setDate(nextMonday.getDate() + 7);
            return getCurrentWeekKey(nextMonday);
        }
        function getISOWeekNumber(date) {
            const tmp = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            tmp.setDate(tmp.getDate() - dayNr + 3);
            const firstThursday = tmp.valueOf();
            tmp.setMonth(0, 1);
            if (tmp.getDay() !== 4) {
                tmp.setMonth(0, 1 + ((4 - tmp.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - tmp) / 604800000);
        }
    </script>
</body>

</html>