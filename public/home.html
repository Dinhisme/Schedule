<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω L·ªãch Tr·ª±c</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/x-icon" href="img/logoKHTHIT.ico">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- <div class="header">
            <h1>Qu·∫£n L√Ω L·ªãch Tr·ª±c</h1>
        </div> -->

        <div class="department-manager">
            <!-- <h3>Qu·∫£n l√Ω Khoa/Ph√≤ng</h3>
            <div class="department-input">
                <input type="text" id="departmentInput" placeholder="Nh·∫≠p t√™n khoa/ph√≤ng..."
                    onkeypress="handleDepartmentEnter(event)">
                <button class="btn btn-primary" onclick="addDepartment()">Th√™m Khoa/Ph√≤ng</button>
            </div> -->
            <div class="department-list" id="departmentList" style="display: none;"></div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary active" id="currentWeekBtn" onclick="showWeek('current')">Tu·∫ßn Hi·ªán
                T·∫°i</button>
            <button class="btn btn-secondary" id="nextWeekBtn" onclick="showWeek('next')">Tu·∫ßn Ti·∫øp Theo</button>
            <button class="btn btn-secondary" onclick="exportSchedule()">üìã Xu·∫•t L·ªãch</button>
            <select id="weekSelector" class="btn btn-secondary" style="margin-right:0px;"></select>
        </div>

        <div id="currentWeekSchedule" class="schedule-container">
            <div class="week-title" id="currentWeekTitle"></div>
            <div class="schedule-grid" id="currentGrid"></div>
        </div>

        <div id="nextWeekSchedule" class="schedule-container" style="display: none;">
            <div class="week-title" id="nextWeekTitle"></div>
            <div class="schedule-grid" id="nextGrid"></div>
        </div>
    </div>


    <script>
        let departments = ['Tr·ª±c L√£nh ƒê·∫°o', 'Th∆∞·ªùng tr√∫', 'Tr∆∞·ªüng tua', 'Bs Khoa CC', 'Khoa C·∫•p C·ª©u', 'Khoa CC Nhi-S∆° sinh', 'Bs Khoa Sanh', 'Khoa Sanh', 'Bs Khoa SB', 'Khoa SB', 'Bs Khoa Ph·ª•', 'Khoa Ph·ª•', 'Bs Khoa HP', 'Khoa HP',
            'Bs Khoa HS', 'Khoa HS', 'Bs Khoa ƒêTTYC', 'Khoa ƒêTTYC', 'Khu A', 'Khu B', 'Khu C', 'TT Khoa Ptgm Hsct-Cƒë', 'Khoa Ptgm Hsct-Cƒë Kv G√¢y m√™', 'Khoa Ptgm-Hstc-Cƒë KV ICU',
            'Khoa Ptgm-Hstc-Cƒë Bs Kh·∫©m Ti·ªÅn M√™', 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë Ng√†y', 'ƒêD tr∆∞c ICU Ng√†y', 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë ƒê√™m', 'ƒêD tr·ª±c ICU ƒê√™m',
            'TT Khoa Nhi-Ss', 'Khoa Nhi-S∆° Sinh', 'Khoa Ksnk Th∆∞·ªùng Tr√∫', 'X√©t Nghi·ªám', 'Si√™u √Çm', 'TT S√¢ Tim', 'X Quang', 'TT X Quang', 'K·∫ø To√°n',
            'KD∆∞·ª£c', 'Th∆∞·ªùng Tr√∫ B·∫£o Tr√¨', 'Phcqt', 'T√†i X·∫ø', 'Tin H·ªçc', 'Khoa Nhi SS TK', 'Khoa Ptgm-Hstc-Cd (KV h·ªìi s√∫c sau m·ªó) TK', 'ƒêD Tr·ª±c Ptgm Hstc-Cd Ng√†y TK',
            'ƒêD Tr·ª±c Ptgm Hstc-Cd ƒê√™m TK', 'Khoa Ph·ª• TK', 'Khoa Sanh TK', 'Khoa SB TK', 'Khoa C–° TK', 'Khoa Sanh 13h-17h', 'Khoa CC 13h-17h', 'Khoa Ptgm-Hstc-Cƒë',
            'Khoa Sanh TC'
        ];

        const daysOfWeek = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß Nh·∫≠t'];
        let activeWeek = 'current';
        let currentWeekSchedule = {};
        let nextWeekSchedule = {};
        let currentEditingCell = null;

        // S·ªë ca cho t·ª´ng khoa
        function getShiftsForDept(dept) {
            switch (dept) {

                case 'Tr·ª±c L√£nh ƒê·∫°o':
                    return ['H√†ng 1'];

                case 'Th∆∞·ªùng tr√∫':
                    return ['H√†ng 1'];

                case 'Tr∆∞·ªüng tua':
                    return ['H√†ng 1'];

                case 'Bs Khoa CC':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'];

                case 'Khoa C·∫•p C·ª©u':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', 'H√†ng 9', 'H√†ng 10', 'H√†ng 11', 'H√†ng 12'];

                case 'Khoa CC Nhi-S∆° sinh':
                    return ['H√†ng 1', 'H√†ng 2']

                case 'Bs Khoa Sanh':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'];

                case 'Khoa Sanh':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', 'H√†ng 9', 'H√†ng 10', 'H√†ng 11', 'H√†ng 12'];

                case 'Bs Khoa SB':
                    return ['H√†ng 1'];

                case 'Khoa SB':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6'];

                case 'Bs Khoa Ph·ª•':
                    return ['H√†ng 1'];

                case 'Khoa Ph·ª•':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'];

                case 'Bs Khoa HP':
                    return ['H√†ng 1'];

                case 'Khoa HP':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'];

                case 'Bs Khoa HS':
                    return ['H√†ng 1'];

                case 'Khoa HS':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'];

                case 'Bs Khoa ƒêTTYC':
                    return ['H√†ng 1'];

                case 'Khoa ƒêTTYC':
                    return ['H√†ng 1'];

                case 'Khu A':
                    return ['H√†ng 1'];

                case 'Khu B':
                    return ['H√†ng 1'];

                case 'Khu C':
                    return ['H√†ng 1'];

                case 'TT Khoa Ptgm Hsct-Cƒë':
                    return ['H√†ng 1'];

                case 'Khoa Ptgm-Hstc-Cƒë KV G√¢y m√™':
                    return ['H√†ng 1', 'H√†ng 2'];

                case 'Khoa Ptgm-Hstc-Cƒë KV ICU':
                    return ['H√†ng 1'];

                case 'Khoa Pigm-Hstc-Cƒë Bs Kh·∫©m Ti·ªÅn M√™':
                    return ['H√†ng 1'];

                case 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë Ng√†y':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8'];

                case 'ƒêD tr∆∞c ICU Ng√†y':
                    return ['H√†ng 1'];

                case 'ƒêD Tr·ª±c Ptgm Hstc-Cƒë ƒê√™m':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8'];

                case 'ƒêD tr·ª±c ICU ƒê√™m':
                    return ['H√†ng 1'];

                case 'TT Khoa Nhi-Ss':
                    return ['H√†ng 1'];

                case 'Khoa Nhi-S∆° Sinh':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', ' H√†ng 9', 'H√†ng 10'];

                case 'Khoa Ksnk Th∆∞·ªùng Tr√∫':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];

                case 'X√©t Nghi·ªám':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'];

                case 'Si√™u √Çm':
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];

                case 'TT S√¢ Tim':
                    return ['H√†ng 1'];

                case 'X Quang':
                    return ['H√†ng 1'];

                case 'TT X Quang':
                    return ['H√†ng 1'];

                case 'K·∫ø To√°n':
                    return ['H√†ng 1'];

                case 'Khoa D∆∞·ª£c':
                    return ['H√†ng 1'];

                case 'Th∆∞·ªùng Tr√∫ B·∫£o Tr√¨':
                    return ['H√†ng 1'];

                case 'Phcqt':
                    return ['H√†ng 1'];

                case 'T√†i X·∫ø':
                    return ['H√†ng 1'];

                case 'Tin H·ªçc':
                    return ['H√†ng 1'];

                case 'Khoa Nhi SS TK':
                    return ['H√†ng 1'];

                case 'Khoa Ptgm-Hstc-Cd (KV h·ªìi s√∫c sau m·ªó) TK':
                    return ['H√†ng 1'];

                case 'ƒêD Tr·ª±c Ptgm Hstc-Cd Ng√†y TK':
                    return ['H√†ng 1'];

                case 'ƒêD Tr·ª±c Ptgm Hstc-Cd ƒê√™m TK':
                    return ['H√†ng 1'];

                case 'Khoa Ph·ª• TK':
                    return ['H√†ng 1'];

                case 'Khoa Sanh TK':
                    return ['H√†ng 1'];

                case 'Khoa SB TK':
                    return ['H√†ng 1'];

                case 'Khoa C–° TK':
                    return ['H√†ng 1'];

                case 'Khoa Sanh 13h-17h':
                    return ['H√†ng 1'];

                case 'Khoa CC 13h-17h':
                    return ['H√†ng 1'];

                case 'Khoa Ptgm-Hstc-Cƒë':
                    return ['H√†ng 1'];

                case 'Khoa Sanh TC':
                    return ['H√†ng 1']

                default:
                    return ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'];


            }
        }

        function renderDepartments() {
            const container = document.getElementById('departmentList');
            container.innerHTML = departments.map((dept, index) =>
                `<div class="department-tag">
                    ${dept}
                    <button class="remove" onclick="removeDepartment(${index})">√ó</button>
                </div>`
            ).join('');
        }

        // Week management
        function showWeek(week) {
            activeWeek = week;
            document.getElementById('currentWeekBtn').classList.toggle('active', week === 'current');
            document.getElementById('nextWeekBtn').classList.toggle('active', week === 'next');

            const selector = document.getElementById('weekSelector');
            let weekKey = week === 'current' ? getCurrentWeekKey() : getNextWeekKey();
            selector.value = weekKey;
            loadAllSchedules(weekKey);

            // C·∫≠p nh·∫≠t ƒë√∫ng ti√™u ƒë·ªÅ cho t·ª´ng tu·∫ßn
            if (week === 'current') {
                document.getElementById('currentWeekSchedule').style.display = 'block';
                document.getElementById('nextWeekSchedule').style.display = 'none';
                generateGrid('currentGrid');
                updateWeekTitleByKey(weekKey, 'currentWeekTitle');
            } else {
                document.getElementById('currentWeekSchedule').style.display = 'none';
                document.getElementById('nextWeekSchedule').style.display = 'block';
                generateGrid('nextGrid');
                updateWeekTitleByKey(weekKey, 'nextWeekTitle');
            }
        }

        // function updateWeekTitles() {
        //     const today = new Date();
        //     const currentMonday = getMonday(today);
        //     const nextMonday = new Date(currentMonday);
        //     nextMonday.setDate(nextMonday.getDate() + 7);

        //     document.getElementById('currentWeekTitle').textContent =
        //         `Tu·∫ßn Hi·ªán T·∫°i (${formatDate(currentMonday)} - ${formatDate(new Date(currentMonday.getTime() + 6 * 24 * 60 * 60 * 1000))})`;
        //     document.getElementById('nextWeekTitle').textContent =
        //         `Tu·∫ßn Ti·∫øp Theo (${formatDate(nextMonday)} - ${formatDate(new Date(nextMonday.getTime() + 6 * 24 * 60 * 60 * 1000))})`;
        // }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        }

        // Schedule grid generation
        function generateScheduleGrids() {
            generateGrid('currentGrid');
        }

        // S·ª≠a l·∫°i generateGrid ƒë·ªÉ l·∫•y d·ªØ li·ªáu ƒë√∫ng theo t√™n khoa/ph√≤ng
        function generateGrid(gridId) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            grid.appendChild(createGridCell('Khoa/Ph√≤ng', 'grid-header'));
            daysOfWeek.forEach(day => {
                grid.appendChild(createGridCell(day, 'grid-header'));
            });

            departments.forEach((dept) => {
                grid.appendChild(createGridCell(dept, 'grid-cell department-row'));
                for (let day = 0; day < 7; day++) {
                    const cell = createGridCell('', 'grid-cell');
                    let shifts = getShiftsForDept(dept);

                    shifts.forEach((shift) => {
                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'shift-slot';
                        slotDiv.textContent = shift;
                        slotDiv.draggable = true;
                        slotDiv.dataset.department = dept;
                        slotDiv.dataset.day = day;
                        slotDiv.dataset.shift = shift;
                        slotDiv.dataset.gridId = gridId;

                        // Drag events
                        slotDiv.ondragstart = handleDragStart;
                        slotDiv.ondragover = handleDragOver;
                        slotDiv.ondrop = handleDrop;
                        slotDiv.ondragenter = handleDragEnter;
                        slotDiv.ondragleave = handleDragLeave;

                        // Click ƒë·ªÉ ch·ªânh s·ª≠a
                        slotDiv.onclick = (e) => {
                            if (e.detail === 1 && !slotDiv.classList.contains('dragging')) {
                                openShiftModal(gridId, dept, day, shift);
                            }
                        };

                        // Hi·ªÉn th·ªã d·ªØ li·ªáu n·∫øu c√≥
                        const week = gridId.includes('current') ? 'current' : 'next';
                        const scheduleData = week === 'current' ? currentWeekSchedule : nextWeekSchedule;
                        const key = `${dept}_${day}_${shift}`;
                        const data = scheduleData[key];
                        if (data) {
                            slotDiv.className = 'shift-slot filled';
                            slotDiv.innerHTML = `<strong>${data.staff}</strong>`;
                        }

                        cell.appendChild(slotDiv);
                    });
                    grid.appendChild(cell);
                }
            });
        }

        function createGridCell(content, className) {
            const cell = document.createElement('div');
            cell.className = className;
            cell.innerHTML = content;
            return cell;
        }

        // Drag & Drop handlers
        let dragSource = null;
        function handleDragStart(e) {
            dragSource = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                deptIndex: this.dataset.deptIndex,
                day: this.dataset.day,
                shift: this.dataset.shift,
                gridId: this.dataset.gridId
            }));
        }
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (!dragSource) return;
            const src = JSON.parse(e.dataTransfer.getData('text/plain'));
            const dest = {
                deptIndex: this.dataset.deptIndex,
                day: this.dataset.day,
                shift: this.dataset.shift,
                gridId: this.dataset.gridId
            };
            if (src.deptIndex === dest.deptIndex && src.day === dest.day && src.shift === dest.shift && src.gridId === dest.gridId) return;

            const srcWeek = src.gridId.includes('current') ? 'current' : 'next';
            const srcSchedule = srcWeek === 'current' ? currentWeekSchedule : nextWeekSchedule;
            const srcDept = departments[src.deptIndex];
            const srcKey = `${srcDept}_${src.day}_${src.shift}`;
            const srcData = srcSchedule[srcKey];

            const destWeek = dest.gridId.includes('current') ? 'current' : 'next';
            const destSchedule = destWeek === 'current' ? currentWeekSchedule : nextWeekSchedule;
            const destDept = departments[dest.deptIndex];
            const destKey = `${destDept}_${dest.day}_${dest.shift}`;
            const destData = destSchedule[destKey];

            if (srcData) {
                destSchedule[destKey] = { ...srcData, department: destDept, day: dest.day, shift: dest.shift };
                delete srcSchedule[srcKey];
                generateScheduleGrids();
            }
            dragSource.classList.remove('dragging');
            dragSource = null;
        }

        async function exportSchedule() {
            const week = activeWeek === 'current' ? 'Hi·ªán T·∫°i' : 'Ti·∫øp Theo';
            const scheduleData = activeWeek === 'current' ? currentWeekSchedule : nextWeekSchedule;

            // L·∫•y ti√™u ƒë·ªÅ ƒëang hi·ªÉn th·ªã
            const titleId = activeWeek === 'current' ? 'currentWeekTitle' : 'nextWeekTitle';
            let fileTitle = document.getElementById(titleId).textContent || 'L·ªãch tr·ª±c';

            // T√¨m 2 ng√†y trong ti√™u ƒë·ªÅ
            const match = fileTitle.match(/(\d{2})\/(\d{2})\/(\d{4})\s*-\s*(\d{2})\/(\d{2})\/(\d{4})/);
            if (match) {
                // ƒê·ªïi ƒë·ªãnh d·∫°ng dd/mm/yyyy th√†nh dd.mm.yyyy
                const from = `${match[1]}.${match[2]}.${match[3]}`;
                const to = `${match[4]}.${match[5]}.${match[6]}`;
                fileTitle = `L·ªãch tr·ª±c t·ª´ ng√†y ${from} ƒë·∫øn ng√†y ${to}`;
            } else {
                // fallback n·∫øu kh√¥ng match
                fileTitle = fileTitle.replace(/[\/\\:*?"<>|]/g, '').replace(/\s+/g, '-');
            }

            const dataToSend = {
                data: scheduleData,
                week: week,
                shifts: {
                    'Tr·ª±c L√£nh ƒê·∫°o': 
                        ['H√†ng 1'],

                    'Th∆∞·ªùng tr√∫': 
                        ['H√†ng 1'],

                    'Tr∆∞·ªüng tua': 
                        ['H√†ng 1'],

                    'Bs Khoa CC':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'],

                    'Khoa C·∫•p C·ª©u':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', 'H√†ng 9', 'H√†ng 10', 'H√†ng 11', 'H√†ng 12'],

                    'Khoa CC Nhi-S∆° sinh':
                        ['H√†ng 1', 'H√†ng 2'],

                    'Bs Khoa Sanh':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'],

                    'Khoa Sanh':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', 'H√†ng 9', 'H√†ng 10', 'H√†ng 11', 'H√†ng 12'],

                    'Bs Khoa SB':
                        ['H√†ng 1'],

                    'Khoa SB':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6'],

                    'Bs Khoa Ph·ª•':
                        ['H√†ng 1'],

                    'Khoa Ph·ª•':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'],

                    'Bs Khoa HP':
                        ['H√†ng 1'],

                    'Khoa HP':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'],

                    'Bs Khoa HS':
                        ['H√†ng 1'],

                    'Khoa HS':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5'],

                    'Bs Khoa ƒêTTYC':
                        ['H√†ng 1'],

                    'Khoa ƒêTTYC':
                        ['H√†ng 1'],

                    'Khu A':
                        ['H√†ng 1'],

                    'Khu B':
                        ['H√†ng 1'],

                    'Khu C':
                        ['H√†ng 1'],

                    'TT Khoa Ptgm Hsct-Cƒë':
                        ['H√†ng 1'],

                    'Khoa Ptgm-Hstc-Cƒë KV G√¢y m√™':
                        ['H√†ng 1', 'H√†ng 2'],

                    'Khoa Ptgm-Hstc-Cƒë KV ICU':
                        ['H√†ng 1'],

                    'Khoa Pigm-Hstc-Cƒë Bs Kh·∫©m Ti·ªÅn M√™':
                        ['H√†ng 1'],

                    'ƒêD Tr·ª±c Ptgm Hstc-Cƒë Ng√†y':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8'],

                    'ƒêD tr∆∞c ICU Ng√†y':
                        ['H√†ng 1'],

                    'ƒêD Tr·ª±c Ptgm Hstc-Cƒë ƒê√™m':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8'],

                    'ƒêD tr·ª±c ICU ƒê√™m':
                        ['H√†ng 1'],

                    'TT Khoa Nhi-Ss':
                        ['H√†ng 1'],

                    'Khoa Nhi-S∆° Sinh':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4', 'H√†ng 5', 'H√†ng 6', 'H√†ng 7', 'H√†ng 8', ' H√†ng 9', 'H√†ng 10'],

                    'Khoa Ksnk Th∆∞·ªùng Tr√∫':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'],

                    'X√©t Nghi·ªám':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3', 'H√†ng 4'],

                    'Si√™u √Çm':
                        ['H√†ng 1', 'H√†ng 2', 'H√†ng 3'],

                    'TT S√¢ Tim':
                        ['H√†ng 1'],

                    'X Quang':
                        ['H√†ng 1'],

                    'TT X Quang':
                        ['H√†ng 1'],

                    'K·∫ø To√°n':
                        ['H√†ng 1'],

                    'Khoa D∆∞·ª£c':
                        ['H√†ng 1'],

                    'Th∆∞·ªùng Tr√∫ B·∫£o Tr√¨':
                        ['H√†ng 1'],

                    'Phcqt':
                        ['H√†ng 1'],

                    'T√†i X·∫ø':
                        ['H√†ng 1'],

                    'Tin H·ªçc':
                        ['H√†ng 1'],

                    'Khoa Nhi SS TK':
                        ['H√†ng 1'],

                    'Khoa Ptgm-Hstc-Cd (KV h·ªìi s√∫c sau m·ªó) TK':
                        ['H√†ng 1'],

                    'ƒêD Tr·ª±c Ptgm Hstc-Cd Ng√†y TK':
                        ['H√†ng 1'],

                    'ƒêD Tr·ª±c Ptgm Hstc-Cd ƒê√™m TK':
                        ['H√†ng 1'],

                    'Khoa Ph·ª• TK':
                        ['H√†ng 1'],

                    'Khoa Sanh TK':
                        ['H√†ng 1'],

                    'Khoa SB TK':
                        ['H√†ng 1'],

                    'Khoa C–° TK':
                        ['H√†ng 1'],

                    'Khoa Sanh 13h-17h':
                        ['H√†ng 1'],

                    'Khoa CC 13h-17h':
                        ['H√†ng 1'],

                    'Khoa Ptgm-Hstc-Cƒë':
                        ['H√†ng 1'],

                    'Khoa Sanh TC':
                        ['H√†ng 1']
                }
            };

            const res = await fetch('/api/exportexcel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scheduleData: dataToSend, week })
            });

            if (res.ok) {
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileTitle}.xlsx`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert('Xu·∫•t file th·∫•t b·∫°i!');
            }
        }

        // T·∫£i l·ªãch tr·ª±c t·ªïng h·ª£p t·ª´ t·∫•t c·∫£ t√†i kho·∫£n
        async function loadAllSchedules(weekKey) {
            const res = await fetch('/api/all-schedules');
            if (!res.ok) {
                alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu l·ªãch tr·ª±c!');
                return;
            }
            const allSchedules = await res.json();

            let scheduleData = {};

            Object.values(allSchedules).forEach(userSchedule => {
                if (userSchedule.weeks && userSchedule.weeks[weekKey]) {
                    userSchedule.weeks[weekKey].forEach(item => {
                        if (departments.includes(item.department)) {
                            const key = `${item.department}_${item.day}_${item.shift}`;
                            scheduleData[key] = item;
                        }
                    });
                }
            });

            // C·∫≠p nh·∫≠t c·∫£ hai bi·∫øn theo tu·∫ßn ƒëang ch·ªçn
            if (activeWeek === 'current') {
                currentWeekSchedule = scheduleData;
                generateGrid('currentGrid');
            } else {
                nextWeekSchedule = scheduleData;
                generateGrid('nextGrid');
            }
        }

        async function saveScheduleToServer() {
            const weekKey = activeWeek === 'current' ? getCurrentWeekKey() : getNextWeekKey();
            // Chuy·ªÉn object v·ªÅ array ƒë·ªÉ l∆∞u
            const scheduleArr = Object.values(activeWeek === 'current' ? currentWeekSchedule : nextWeekSchedule);
            await fetch('/api/save-schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: 'public',
                    weekKey,
                    schedule: scheduleArr
                })
            });
        }

        // ƒê√≥ng modal khi click ra ngo√†i
        window.onclick = function (event) {
            const modal = document.getElementById('shiftModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize the application
        async function init() {
            renderDepartments();
            generateScheduleGrids();
            await loadWeekOptions();
            const selector = document.getElementById('weekSelector');
            loadAllSchedules(selector.value);
            updateWeekTitleByKey(selector.value);
        }

        // Kh·ªüi t·∫°o trang
        document.addEventListener('DOMContentLoaded', init);

        function getCurrentWeekKey(date = new Date()) {
            const year = date.getFullYear();
            const week = getISOWeekNumber(date);
            return `${year}-${week}`;
        }
        function getNextWeekKey() {
            const today = new Date();
            const nextMonday = getMonday(today);
            nextMonday.setDate(nextMonday.getDate() + 7);
            return getCurrentWeekKey(nextMonday);
        }
        function getISOWeekNumber(date) {
            const tmp = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            tmp.setDate(tmp.getDate() - dayNr + 3);
            const firstThursday = tmp.valueOf();
            tmp.setMonth(0, 1);
            if (tmp.getDay() !== 4) {
                tmp.setMonth(0, 1 + ((4 - tmp.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - tmp) / 604800000);
        }

        async function loadWeekOptions() {
            const res = await fetch('/api/all-schedules');
            if (!res.ok) return;
            const allSchedules = await res.json();
            let weekSet = new Set();
            Object.values(allSchedules).forEach(userSchedule => {
                if (userSchedule.weeks) {
                    Object.keys(userSchedule.weeks).forEach(weekKey => weekSet.add(weekKey));
                }
            });

            // S·∫Øp x·∫øp tu·∫ßn gi·∫£m d·∫ßn (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
            const weekList = Array.from(weekSet).sort((a, b) => b.localeCompare(a));
            const selector = document.getElementById('weekSelector');
            selector.innerHTML = weekList.map(w => {
                const [year, week] = w.split('-').map(Number);
                function getMondayOfISOWeek(week, year) {
                    const simple = new Date(year, 0, 1 + (week - 1) * 7);
                    const dow = simple.getDay();
                    const monday = simple;
                    if (dow <= 4)
                        monday.setDate(simple.getDate() - simple.getDay() + 1);
                    else
                        monday.setDate(simple.getDate() + 8 - simple.getDay());
                    return monday;
                }
                const monday = getMondayOfISOWeek(week, year);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                function formatDate(date) {
                    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
                return `<option value="${w}">${formatDate(monday)} - ${formatDate(sunday)}</option>`;
            }).join('');
            // Ch·ªçn tu·∫ßn hi·ªán t·∫°i m·∫∑c ƒë·ªãnh
            const currentKey = getCurrentWeekKey();
            selector.value = currentKey;
        }

        document.getElementById('weekSelector').addEventListener('change', function () {
            // X√°c ƒë·ªãnh tu·∫ßn v·ª´a ch·ªçn l√† tu·∫ßn hi·ªán t·∫°i hay tu·∫ßn ti·∫øp theo
            const currentKey = getCurrentWeekKey();
            const nextKey = getNextWeekKey();
            if (this.value === currentKey) {
                showWeek('current');
            } else if (this.value === nextKey) {
                showWeek('next');
            } else {
                // N·∫øu l√† tu·∫ßn kh√°c, v·∫´n hi·ªÉn th·ªã ·ªü currentWeekSchedule
                activeWeek = 'current';
                currentWeekSchedule = {};
                loadAllSchedules(this.value);
                updateWeekTitleByKey(this.value);
                document.getElementById('currentWeekSchedule').style.display = 'block';
                document.getElementById('nextWeekSchedule').style.display = 'none';
                generateGrid('currentGrid');
            }
        });

        function updateWeekTitleByKey(weekKey, elementId = 'currentWeekTitle') {
            const [year, week] = weekKey.split('-').map(Number);

            function getMondayOfISOWeek(week, year) {
                const simple = new Date(year, 0, 1 + (week - 1) * 7);
                const dow = simple.getDay();
                const monday = simple;
                if (dow <= 4)
                    monday.setDate(simple.getDate() - simple.getDay() + 1);
                else
                    monday.setDate(simple.getDate() + 8 - simple.getDay());
                return monday;
            }

            const monday = getMondayOfISOWeek(week, year);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            function formatDate(date) {
                return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            document.getElementById(elementId).textContent =
                `L·ªãch tr·ª±c ${formatDate(monday)} - ${formatDate(sunday)}`;
        }
    </script>
</body>

</html>